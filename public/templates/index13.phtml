<?php
use Analytics\MarketingDashboardFormatter;

$formatValue = static function (float|int|null $value, string $format): string {
    $value ??= 0;
    switch ($format) {
        case 'currency':
            return number_format((float) $value, 0, ',', ' ') . ' ₽';
        case 'decimal':
            return number_format((float) $value, 2, ',', ' ');
        default:
            return number_format((float) $value, 0, ',', ' ');
    }
};

$summaryMetrics = [
    ['label' => 'Выручка', 'key' => 'total_revenue', 'format' => 'currency'],
    ['label' => 'Заказы', 'key' => 'total_orders', 'format' => 'number'],
    ['label' => 'Клиенты', 'key' => 'total_customers', 'format' => 'number'],
    ['label' => 'Средний чек', 'key' => 'avg_receipt', 'format' => 'currency'],
    ['label' => 'Новые клиенты', 'key' => 'new_customers', 'format' => 'number'],
    ['label' => 'Повторные клиенты', 'key' => 'repeat_customers', 'format' => 'number'],
    ['label' => 'Частота заказов', 'key' => 'avg_frequency', 'format' => 'decimal'],
];
$chartConfigs = [];
$currentPeriodDays = $start->diff($end)->days + 1;
$previousPeriodDays = $prevStart->diff($prevEnd)->days + 1;
?>
<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Маркетинговая аналитика</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .delta-up { color:#0a0; font-weight:bold; }
        .delta-down { color:#c00; font-weight:bold; }
        .delta-null { color:#999; }
        .table-sm td, .table-sm th { padding: .3rem; }
        .product-card { border:1px solid #ddd; border-radius:6px; padding:3px 10px; margin:3px 0; background:#fafafa; }
        .product-title { font-weight:500; }
        .product-meta { font-size:0.85em; color:#666; }
        .summary-chart { position: relative; height: 120px; }
        .summary-chart canvas { max-height: 120px; }
        .status-select-group { gap: 0.75rem; }
    </style>
</head>
<body class="bg-light p-3">
<div class="container-fluid">
    <h1 class="mb-4">Маркетинговая аналитика</h1>

    <form method="get" class="row g-3 mb-4">
        <div class="col-md-3">
            <label class="form-label">Начало</label>
            <input type="date" class="form-control" name="start" value="<?=htmlspecialchars($start->format('Y-m-d'))?>">
        </div>
        <div class="col-md-3">
            <label class="form-label">Конец</label>
            <input type="date" class="form-control" name="end" value="<?=htmlspecialchars($end->format('Y-m-d'))?>">
        </div>
        <div class="col-md-4">
            <label class="form-label d-block">Статусы заказов</label>
            <div class="d-flex flex-wrap status-select-group">
                <?php foreach ($statusOptions as $statusValue => $statusLabel): ?>
                    <?php $statusId = 'status-' . $statusValue; ?>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="status[]" value="<?=htmlspecialchars((string) $statusValue)?>" id="<?=htmlspecialchars($statusId)?>" <?=in_array($statusValue, $selectedStatuses, true) ? 'checked' : ''?>>
                        <label class="form-check-label" for="<?=htmlspecialchars($statusId)?>">
                            <?=htmlspecialchars($statusLabel)?>
                        </label>
                    </div>
                <?php endforeach; ?>
            </div>
            <div class="form-text">Показатели рассчитываются по выбранным статусам.</div>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100">Обновить</button>
        </div>
    </form>

    <?php if (!empty($selectedStatuses)): ?>
        <div class="mb-4">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="text-muted small">Выбраны статусы:</span>
                <?php foreach ($selectedStatuses as $statusValue): ?>
                    <span class="badge bg-secondary">
                        <?=htmlspecialchars($statusOptions[$statusValue] ?? ('Статус #' . $statusValue))?>
                    </span>
                <?php endforeach; ?>
            </div>
        </div>
    <?php endif; ?>

    <div class="row row-cols-1 row-cols-md-2 g-3 mb-4">
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-1">Текущий период</h6>
                    <strong><?=$start->format('d.m.Y')?> — <?=$end->format('d.m.Y')?></strong>
                    <div class="text-muted small">Длительность: <?=$currentPeriodDays?> дн.</div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-1">Предыдущий период</h6>
                    <strong><?=$prevStart->format('d.m.Y')?> — <?=$prevEnd->format('d.m.Y')?></strong>
                    <div class="text-muted small">Длительность: <?=$previousPeriodDays?> дн.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-3 mb-4">
        <?php foreach ($summaryMetrics as $metric): ?>
            <?php
            $key = $metric['key'];
            $currentValue = $totals[$key] ?? 0;
            $previousValue = $totalsPrev[$key] ?? 0;
            $delta = MarketingDashboardFormatter::calculateDelta($currentValue, $previousValue);
            $summaryChartId = 'summary_' . $key;
            $chartConfigs[] = [
                'id' => $summaryChartId,
                'current' => (float) $currentValue,
                'previous' => (float) $previousValue,
                'label' => $metric['label'],
                'format' => $metric['format'],
            ];
            ?>
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6><?=htmlspecialchars($metric['label'])?></h6>
                        <strong><?=$formatValue($currentValue, $metric['format'])?></strong>

                        <div class="small <?=MarketingDashboardFormatter::deltaClass($delta)?> mt-2">
                            Было: <?=$formatValue($previousValue, $metric['format'])?>
                            (<?=MarketingDashboardFormatter::formatDelta($delta)?>)
                        </div>

                        <div class="summary-chart mt-3">
                            <canvas id="<?=htmlspecialchars($summaryChartId)?>"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        <?php endforeach; ?>
    </div>

    <ul class="nav nav-tabs" id="segmentTabs" role="tablist">
        <?php $first = true; foreach ($allMetrics as $dim => $block): ?>
            <li class="nav-item" role="presentation">
                <button class="nav-link <?=$first ? 'active' : ''?>" id="tab-<?=$dim?>" data-bs-toggle="tab" data-bs-target="#pane-<?=$dim?>" type="button" role="tab">
                    <?=htmlspecialchars($dimensionList[$dim]['label'])?>
                </button>
            </li>
            <?php $first = false; endforeach; ?>
    </ul>

    <div class="tab-content mt-3">
        <?php $first = true; foreach ($allMetrics as $dim => $block): ?>
            <?php
            $previousMap = [];
            foreach ($block['previous'] as $prevRow) {
                $previousMap[$prevRow['dimension_value']] = $prevRow;
            }
            $defaultPrev = [
                'total_revenue' => 0,
                'total_orders' => 0,
                'total_customers' => 0,
                'avg_receipt' => 0,
                'new_customers' => 0,
                'repeat_customers' => 0,
                'avg_frequency' => 0,
            ];
            ?>
            <div class="tab-pane fade <?=$first ? 'show active' : ''?>" id="pane-<?=$dim?>" role="tabpanel">
                <div class="row g-3">
                    <?php foreach ($block['current'] as $metricRow): ?>
                        <?php
                        $value = $metricRow['dimension_value'];
                        $prev = $previousMap[$value] ?? $defaultPrev;
                        $chartId = 'chart_' . $dim . '_' . preg_replace('/[^A-Za-z0-9_-]/', '_', (string) $value);
                        $revenueDelta = MarketingDashboardFormatter::calculateDelta($metricRow['total_revenue'] ?? 0, $prev['total_revenue'] ?? 0);
                        $ordersDelta = MarketingDashboardFormatter::calculateDelta($metricRow['total_orders'] ?? 0, $prev['total_orders'] ?? 0);
                        $customersDelta = MarketingDashboardFormatter::calculateDelta($metricRow['total_customers'] ?? 0, $prev['total_customers'] ?? 0);
                        $avgReceiptDelta = MarketingDashboardFormatter::calculateDelta($metricRow['avg_receipt'] ?? 0, $prev['avg_receipt'] ?? 0);
                        $newCustomersDelta = MarketingDashboardFormatter::calculateDelta($metricRow['new_customers'] ?? 0, $prev['new_customers'] ?? 0);
                        $repeatCustomersDelta = MarketingDashboardFormatter::calculateDelta($metricRow['repeat_customers'] ?? 0, $prev['repeat_customers'] ?? 0);
                        $frequencyDelta = MarketingDashboardFormatter::calculateDelta($metricRow['avg_frequency'] ?? 0, $prev['avg_frequency'] ?? 0);
                        $chartConfigs[] = [
                            'id' => $chartId,
                            'current' => (float) ($metricRow['total_revenue'] ?? 0),
                            'previous' => (float) ($prev['total_revenue'] ?? 0),
                            'label' => 'Выручка',
                            'format' => 'currency',
                        ];
                        ?>
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <h5><?=htmlspecialchars(MarketingDashboardFormatter::formatDimensionValue($dim, $value, $cityMap))?></h5>
                                    <p class="text-muted small">
                                        Текущий: <?=$start->format('d.m.Y')?> — <?=$end->format('d.m.Y')?><br>
                                        Предыдущий: <?=$prevStart->format('d.m.Y')?> — <?=$prevEnd->format('d.m.Y')?>
                                    </p>

                                    <table class="table table-sm align-middle">
                                        <tr>
                                            <th>Выручка</th>
                                            <td>
                                                <?=number_format((float) ($metricRow['total_revenue'] ?? 0), 0, ',', ' ')?> ₽<br>
                                                <small class="<?=MarketingDashboardFormatter::deltaClass($revenueDelta)?>">
                                                    Было: <?=number_format((float) ($prev['total_revenue'] ?? 0), 0, ',', ' ')?> ₽
                                                    (<?=MarketingDashboardFormatter::formatDelta($revenueDelta)?>)
                                                </small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Заказы</th>
                                            <td>
                                                <?=number_format((float) ($metricRow['total_orders'] ?? 0), 0, ',', ' ')?><br>
                                                <small class="<?=MarketingDashboardFormatter::deltaClass($ordersDelta)?>">
                                                    Было: <?=number_format((float) ($prev['total_orders'] ?? 0), 0, ',', ' ')?>
                                                    (<?=MarketingDashboardFormatter::formatDelta($ordersDelta)?>)
                                                </small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Клиенты</th>
                                            <td>
                                                <?=number_format((float) ($metricRow['total_customers'] ?? 0), 0, ',', ' ')?><br>
                                                <small class="<?=MarketingDashboardFormatter::deltaClass($customersDelta)?>">
                                                    Было: <?=number_format((float) ($prev['total_customers'] ?? 0), 0, ',', ' ')?>
                                                    (<?=MarketingDashboardFormatter::formatDelta($customersDelta)?>)
                                                </small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Средний чек</th>
                                            <td>
                                                <?=number_format((float) ($metricRow['avg_receipt'] ?? 0), 0, ',', ' ')?> ₽<br>
                                                <small class="<?=MarketingDashboardFormatter::deltaClass($avgReceiptDelta)?>">
                                                    Было: <?=number_format((float) ($prev['avg_receipt'] ?? 0), 0, ',', ' ')?> ₽
                                                    (<?=MarketingDashboardFormatter::formatDelta($avgReceiptDelta)?>)
                                                </small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Новые клиенты</th>
                                            <td>
                                                <?=number_format((float) ($metricRow['new_customers'] ?? 0), 0, ',', ' ')?><br>
                                                <small class="<?=MarketingDashboardFormatter::deltaClass($newCustomersDelta)?>">
                                                    Было: <?=number_format((float) ($prev['new_customers'] ?? 0), 0, ',', ' ')?>
                                                    (<?=MarketingDashboardFormatter::formatDelta($newCustomersDelta)?>)
                                                </small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Повторные клиенты</th>
                                            <td>
                                                <?=number_format((float) ($metricRow['repeat_customers'] ?? 0), 0, ',', ' ')?><br>
                                                <small class="<?=MarketingDashboardFormatter::deltaClass($repeatCustomersDelta)?>">
                                                    Было: <?=number_format((float) ($prev['repeat_customers'] ?? 0), 0, ',', ' ')?>
                                                    (<?=MarketingDashboardFormatter::formatDelta($repeatCustomersDelta)?>)
                                                </small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Частота заказов</th>
                                            <td>
                                                <?=number_format((float) ($metricRow['avg_frequency'] ?? 0), 2, ',', ' ')?><br>
                                                <small class="<?=MarketingDashboardFormatter::deltaClass($frequencyDelta)?>">
                                                    Было: <?=number_format((float) ($prev['avg_frequency'] ?? 0), 2, ',', ' ')?>
                                                    (<?=MarketingDashboardFormatter::formatDelta($frequencyDelta)?>)
                                                </small>
                                            </td>
                                        </tr>
                                    </table>

                                    <canvas id="<?=htmlspecialchars($chartId)?>" height="120"></canvas>

                                    <?php if (!empty($block['products'][$value] ?? [])): ?>
                                        <div class="mt-3">
                                            <h6>Топ товары</h6>
                                            <div class="row">
                                                <?php foreach ($block['products'][$value] as $product): ?>
                                                    <div class="col-6">
                                                        <div class="product-card">
                                                            <div class="product-title"><?=htmlspecialchars($product['title'])?></div>
                                                            <div class="product-meta">
                                                                <?=$product['quantity']?> шт · <?=number_format((float) $product['revenue'], 0, ',', ' ')?> ₽
                                                            </div>
                                                        </div>
                                                    </div>
                                                <?php endforeach; ?>
                                            </div>
                                        </div>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
            <?php $first = false; endforeach; ?>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const chartConfigs = <?=json_encode($chartConfigs, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES)?>;
    const formatters = {
        currency: new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }),
        decimal: new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
        number: new Intl.NumberFormat('ru-RU'),
    };

    chartConfigs.forEach((config) => {
        const canvas = document.getElementById(config.id);
        if (!canvas) {
            return;
        }

        const formatKey = config.format && formatters[config.format] ? config.format : 'number';
        const formatter = formatters[formatKey];
        const datasetLabel = config.label || 'Показатель';
        const dataPoints = [Number(config.current) || 0, Number(config.previous) || 0];

        new Chart(canvas, {
            type: config.type || 'bar',
            data: {
                labels: ['Текущий', 'Предыдущий'],
                datasets: [{
                    label: datasetLabel,
                    data: dataPoints,
                    backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(200, 200, 200, 0.7)'],
                    borderRadius: 6,
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const value = dataPoints[context.dataIndex] ?? 0;
                                return `${context.dataset.label}: ${formatter.format(value)}`;
                            },
                        },
                    },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => formatter.format(Number(value) || 0),
                        },
                    },
                },
            },
        });
    });
</script>
</body>
</html>
