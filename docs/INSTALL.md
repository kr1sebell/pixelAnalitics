# Установка и первичная настройка модуля аналитики

## Предварительные требования

* PHP 8.1 и выше с расширением `mysqli`.
* Доступ к боевой базе данных (далее — source) и отдельной аналитической базе (далее — analytics).
* Cron на сервере приложения.

## 1. Подготовка конфигурации

1. Скопируйте файл `config/config.php` и заполните реквизиты подключения:
   * `source_db` — параметры подключения к боевой базе (таблицы `users`, `zakazy`, `orders_list_*`).
   * `analytics_db` — параметры подключения к новой аналитической базе.
   * `vk` — токен сервисного аккаунта ВКонтакте с правами `users`.
2. При необходимости скорректируйте настройки `segmentation`.

## 2. Развертывание аналитической схемы

Запустите установщик (создаёт все необходимые таблицы в analytics-базе):

```bash
php bin/install.php
```

## 3. Первичная синхронизация

1. Выполните экспорт пользователей, заказов и позиций:

   ```bash
   php bin/sync.php
   ```

   Скрипт заберёт все новые и изменённые заказы из боевой базы (первый запуск — полный), перенесёт пользователей и составы заказов, а также обновит профили ВК.

2. После успешной синхронизации посчитайте сегментацию:

   ```bash
   php bin/segment.php --start="2024-01-01" --end="2024-01-31"
   ```

   Без параметров используется период по умолчанию (последние 7 дней).

## 4. Настройка расписания

Добавьте задания Cron (пример):

```cron
# Ночной импорт данных из боевой базы (03:00)
0 3 * * * /usr/bin/php /var/www/project/bin/sync.php >> /var/log/analytics-sync.log 2>&1

# Пересчёт сегментов после импорта (03:30)
30 3 * * * /usr/bin/php /var/www/project/bin/segment.php >> /var/log/analytics-segmentation.log 2>&1
```

При необходимости добавьте дополнительные задачи для расчёта промежуточных срезов (например, каждые 6 часов).

## 5. Подключение админ-панели

1. Настройте веб-сервер на директорию `public/`.
2. Ограничьте доступ к модулю авторизацией (базовая авторизация веб-сервера или встроенный механизм админки).
3. После успешного запуска Cron откройте `/index.php` и выберите нужный сегмент и период — данные будут загружаться из pre-агрегированных таблиц `analytics_dimension_metrics` и `analytics_dimension_top_products` без нагрузки на боевую базу.

## 6. Обновление схемы

При обновлениях проекта повторно запускайте `php bin/install.php` — скрипт безопасно добавит недостающие таблицы и индексы.
