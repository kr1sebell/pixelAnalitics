# Сегментация и метрики

## Доступные измерения

| Ключ | Описание | Источник |
|------|----------|----------|
| `gender` | Пол пользователя (`male`, `female`, `unknown`) | `analytics_users.gender` (заполняется из VK либо анкеты) |
| `age_group` | Возрастная группа (`under_18`, `18-24`, ..., `65_plus`) | Расчёт по дате рождения пользователя или профилю ВК |
| `city` | Город проживания из профиля | `analytics_users.city` |
| `occupation` | Род деятельности / должность | `analytics_users.occupation` |
| `weekday` | День недели оформления заказа (1–7) | `analytics_orders.weekday` |
| `payment_type` | Способ оплаты (0 — онлайн, 1 — наличные, 2 — терминал) | `analytics_orders.payment_type` |
| `city_id` | Город доставки из заказа | `analytics_orders.city_id` |

При необходимости список расширяется через `Segmentation\DimensionConfig`.

## Набор метрик

Для каждого измерения и периода фиксируются:

* `total_orders` — количество заказов.
* `total_customers` — уникальные клиенты.
* `new_customers` — число клиентов, совершивших первый заказ в выбранном периоде.
* `repeat_customers` — клиенты, у которых есть ≥2 заказа в выбранном периоде.
* `repeat_rate` — доля повторных клиентов (%).
* `total_revenue` — суммарная выручка (`zakazy.summa`).
* `avg_receipt` — средний чек.
* `avg_frequency` — среднее количество заказов на клиента.
* `avg_items` — среднее количество позиций в заказе.
* `top_products` — топ-5 товаров по выручке с количеством продаж.

## Логика расчёта

1. Выборка заказов за период производится из `analytics_orders` (они уже синхронизированы из прод-базы).
2. Для измерений, основанных на пользователях (`gender`, `age_group`, `city`, `occupation`) данные берутся из `analytics_users`. Для остальных — из `analytics_orders`.
3. Повторные заказы определяются по полю `repeat_order` и `order_number > 1`.
4. Новые клиенты — те, у кого `order_number = 1` в выбранном диапазоне.
5. Топ-товары — агрегирование по `analytics_order_items` с сортировкой по сумме выручки.

## Практическое применение

* Можно быстро отфильтровать аудиторию (например, «женщины 25–34 из Москвы») и оценить средний чек, выручку и топовые товары.
* Сравнение периодов позволяет измерить эффект маркетинговых кампаний (рост/падение выручки и повторных заказов).
* Для сравнения «текущий vs предыдущий» нужно пересчитать сегментацию для обоих диапазонов (cron-сценарий может запускать `bin/segment.php` дважды — например, для текущей недели и недели перед ней).
* Дополнительные отчёты (например, heatmap по дням недели и времени) формируются аналогично — достаточно добавить новое измерение и агрегирующую функцию.
