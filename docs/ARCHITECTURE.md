# Архитектура маркетингового модуля

## Общая схема

```
┌────────────┐      ночной cron       ┌────────────────┐
│  Prod БД   │ ───────────────────▶   │ Analytics БД   │
└────────────┘                        └────────────────┘
       │                                        │
       │  SafeMySQL + PHP                       │
       ▼                                        ▼
 ┌───────────────┐                      ┌─────────────────────┐
 │ bin/sync.php  │                      │ pre-агрегированные  │
 │ (ETL)         │                      │ таблицы сегментации │
 └───────────────┘                      └─────────────────────┘
                                                │
                                                ▼
                                      ┌───────────────────┐
                                      │ public/index.php  │
                                      │ (админ модуль)    │
                                      └───────────────────┘
```

## Основные компоненты

### 1. ETL-слой (`src/ETL`)
* **DataSyncService** — инкрементальный перенос пользователей, заказов и позиций заказа из боевой базы (берутся только статусы `1` и `6`, отмены и неоплаченные заказы отбрасываются). Хранит дату последней выгрузки в `analytics_metadata`.
* **VkProfileSyncService** — обновляет профиль пользователя на основе API ВКонтакте. Сохраняет «сырые» данные в `analytics_vk_profiles`, нормализует пол, город, профессию, возраст и возрастную группу в `analytics_users`.
* **Vk\VkApiClient** — лёгкий клиент для методов `users.get` (ограничение на 0.34 сек между батчами соблюдается через `usleep`).

### 2. Схема аналитической БД (`src/Analytics/AnalyticsInstaller.php`)
* `analytics_users` — витрина с enriched-профилями клиентов.
* `analytics_orders` — агрегированная информация о заказах (общая сумма, количество позиций, порядковый номер заказа для пользователя, признак повторности, день недели, способ оплаты, город доставки и его название).
* `analytics_order_items` — детализация состава заказов.
* `analytics_dimension_metrics` — pre-агрегированные метрики по выбранным сегментам и периоду.
* `analytics_dimension_top_products` — топ-5 товаров по выручке для каждой группы.
* `analytics_metadata` — служебные флаги и даты синхронизаций.

### 3. Сегментация (`src/Segmentation`)
* **DimensionConfig** — список доступных измерений (пол, возраст, город, профессия, день недели, способ оплаты и т.д.).
* **SegmentCalculator** — подсчитывает метрики по каждому измерению, используя витрины orders/users. В таблицу `analytics_dimension_metrics` пишется:
  * количество заказов и покупателей;
  * количество новых и повторных клиентов;
  * доля повторных клиентов (repeat rate);
  * выручка, средний чек, средняя частота заказов и среднее количество позиций;
  * топ-товары для сегмента.

### 4. Веб-интерфейс (`public/index.php`)
* Лёгкий PHP-шаблон без JS-фреймворков.
* Поддерживает выбор периода и измерения, строит две таблицы (текущий и предыдущий периоды), показывает дельту по выручке и топ товаров.
* Не обращается к боевой БД — все данные уже предрассчитаны.

## Поток данных

1. **Ночной импорт** (`bin/sync.php`):
   * считывает новые/изменённые строки `zakazy` (по `updated_at`) и соответствующих таблиц состава заказа;
   * пересчитывает агрегаты по пользователям;
   * обновляет или создаёт записи пользователей в `analytics_users`;
   * подтягивает свежие данные из VK API.

2. **Пересчёт сегментов** (`bin/segment.php`):
   * выбирает заказы за указанный период;
   * вычисляет метрики по каждому измерению из `DimensionConfig`;
   * сохраняет результаты в `analytics_dimension_metrics` и `analytics_dimension_top_products`.

3. **Админ-панель**: визуализирует pre-агрегированные данные, позволяет сравнивать периоды (например, текущая неделя vs прошлая).

## Безопасность и производительность

* Все обращения к MySQL — через `SafeMySQL`, исключения обрабатываются в консольных скриптах.
* ETL работает в аналитической базе: при повторном запуске `INSERT ... ON DUPLICATE KEY` устраняет дубли.
* Боевые таблицы не блокируются, т.к. чтение выполняется батчами.
* Сегментация работает с уже выгруженными данными, поэтому может запускаться чаще (каждые N часов) без нагрузки на прод.

## Масштабирование

* Добавление новых сегментов — через расширение `DimensionConfig` и, при необходимости, витрин (например, категория товаров, источник заказа).
* Для сложных графиков можно использовать готовые PHP-библиотеки для генерации изображений (GD, ImageMagick) либо лёгкие JS-библиотеки, если это допустимо политикой проекта.
* Возможен перенос ETL на отдельный сервер/контейнер — достаточно настроить доступ к обеим БД.
